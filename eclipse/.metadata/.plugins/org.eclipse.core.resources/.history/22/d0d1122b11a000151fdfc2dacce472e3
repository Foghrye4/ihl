package ihl.utils;

import ihl.IHLMod;
import ihl.guidebook.IHLGuidebookGui;

import java.io.File;
import java.io.IOException;
import java.util.HashSet;
import java.util.Set;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;

import net.minecraft.item.ItemStack;

import org.w3c.dom.*;
import org.xml.sax.SAXException;

import cpw.mods.fml.relauncher.Side;
import cpw.mods.fml.relauncher.SideOnly;


public class IHLXMLParser {

	public DocumentBuilderFactory dbf;
	public DocumentBuilder db;
	
	public IHLXMLParser() throws ParserConfigurationException
	{
		dbf = DocumentBuilderFactory.newInstance();
	    db = dbf.newDocumentBuilder();
	}
	
	public void visit(Node node, int level, int sectionNumber1, IHLGuidebookGui ihlGuidebookGui) 
	{ 
		int sectionNumber = sectionNumber1;
	    NodeList list = node.getChildNodes(); 
	    Set<ItemStack> iss = new HashSet(4);
	    Set<String> textBlocks = new HashSet(2);
	    for (int i = 0; i < list.getLength(); i++) 
	    {
	      Node childNode = list.item(i); 
	      if(childNode.getNodeName().equals("section"))
	      {
	    	  if(i==sectionNumber)
	    	  {
			      visit(childNode, level + 1, sectionNumber, ihlGuidebookGui); 
	    	  }
	    	  else
	    	  {
	    		  if(list.getLength()<=sectionNumber)
	    		  {
	    			  sectionNumber=0;
	    			  ihlGuidebookGui.setSectionNumber(0);
				      visit(childNode, level + 1, sectionNumber, ihlGuidebookGui); 
	    		  }
	    	  }
	      }
	      else
	      {
		      visit(childNode, level + 1, sectionNumber, ihlGuidebookGui); 
	      }
	      if (node instanceof Element)
		  {
		        Element e = (Element) node; 
		        if(e.getTagName().equals("title"))
		        {
		        	ihlGuidebookGui.setTitle(e.getTextContent());
		        }
		        else if(e.getTagName().equals("itemstack"))
		        {
		        	String[] innername = e.getTextContent().split(":");
		        	iss.add(IHLUtils.getOtherModItemStackWithDamage(innername[0], innername[1], Integer.parseInt(e.getAttribute("damage"))));
		        }
		        else if(e.getTagName().equals("text"))
		        {
		        	textBlocks.add(e.getTextContent());
		        }
		        else if(e.getTagName().equals("image"))
		        {
		        	ihlGuidebookGui.setPicture(e.getTextContent(), Integer.parseInt(e.getAttribute("width")),Integer.parseInt(e.getAttribute("height")));
		        }
		  }
	    } 
	    if(!iss.isEmpty())
	    {
        	ihlGuidebookGui.setItems(iss);
	    }
	    if(!textBlocks.isEmpty())
	    {
        	ihlGuidebookGui.setContent(textBlocks);
	    }
	} 
	 
	public void setupGuidebookGUI(IHLGuidebookGui ihlGuidebookGui, int sectionNumber) throws SAXException, IOException
	{
		Document doc = db.parse(getGuidebookFile());
	    visit(doc, 0, sectionNumber, ihlGuidebookGui); 
	} 
	
    private File getGuidebookFile()
    {
        File folder = new File(IHLMod.proxy.getMinecraftDir(), "config");
        folder.mkdirs();
        return new File(folder, "ihl-guidebook.xml");
    }
	
}
